/*
 * proj_main.c
 *
 *  Created on: 5 Oct 2024
 *      Author: farah
 */
#include<util/delay.h>
#include"lcd.h"
#include"led.h"
#include"buzzer.h"
#include"dc_motor.h"
#include"flame_sensor.h"
#include"lm35_sensor.h"
#include"ldr_sensor.h"
#include"adc.h"
#include "pwm.h"
char temp;

void lcd_display(void)
{
	if(temp>=25)
	    LCD_displayStringRowColumn(0,2,"FAN IS ON        ");
	else
		LCD_displayStringRowColumn(0,2,"FAN IS OFF      ");


	LCD_displayStringRowColumn(1,0,"LDR=");
	char temp2=LDR_getLightIntensity();
	if(temp2 >= 100)
	{
		LCD_intgerToString(temp2);
		LCD_displayCharacter('%');
	}
	else
	{
		LCD_intgerToString(temp2);
		/* In case the digital value is two or one digits print space in the next digit place */

		LCD_displayCharacter('%');
		LCD_displayCharacter(' ');
	}

}
void temp_lcd_display(void)
{
	if(LM35_getTemperature()!=temp)
		{
			 LCD_displayStringRowColumn(1,8,"TEMP=  C");
			 temp = LM35_getTemperature();
			/* Display the temperature value every time at same position */
			 LCD_moveCursor(1,13);
			 LCD_intgerToString(temp);
		}
}

void fire_alert(void)
{
	LCD_clearScreen();
    LCD_displayStringRowColumn(0,1,"CRITICAL ALERT!");
	Buzzer_on();
}

void lightcontrol(uint8 intensity)
{
	if(intensity>70)
	   {
			LED_off(RED_LED);
			LED_off(GREEN_LED);
			LED_off(BLUE_LED);
	    }
	else if(intensity>51)
		{
			LED_on(RED_LED);
			LED_off(GREEN_LED);
			LED_off(BLUE_LED);
		}
	else if(intensity>16)
		{
			LED_on(RED_LED);
			LED_on(GREEN_LED);
			LED_off(BLUE_LED);
		}
	else
		{
			LED_on(RED_LED);
			LED_on(GREEN_LED);
			LED_on(BLUE_LED);
		}
}

void fan_speed_control(uint8 temperature)
{
	if(temperature>=40)
		{
		DcMotor_Rotate(clockwise,100);
		}
	else if(temperature>=35)
		{
		DcMotor_Rotate(anticlockwise,75);
		}
	else if(temperature>=30)
		{
		DcMotor_Rotate(clockwise,50);
		}
	else if(temperature>=25)
		{
		DcMotor_Rotate(clockwise,25);
		}
	else
		{
		DcMotor_Rotate(stop,0);
		}
}

int main(void)
{
	ADC_init();
	PWM_Timer0_Start(100);
	LCD_init();
	LEDS_init();
	DcMotor_Init();
	FlameSensor_init();
	Buzzer_init();
    temp=LM35_getTemperature();
    lcd_display();
    temp_lcd_display();

	while(1)
	{
        lcd_display();
        temp_lcd_display();

        /*FIRE DETECTION AND ALERT*/
        if(FlameSensor_getValue()==1)
        {
        	fire_alert();
        	while(FlameSensor_getValue()==1);
        	LCD_clearScreen();
        	Buzzer_off();
        	temp=-1;
        }

        /*AUTOMATIC LIGHTING CONTROL*/
        lightcontrol(LDR_getLightIntensity());
        /*FAN SPEED CONTROL*/
        fan_speed_control(LM35_getTemperature());



	} /*while end*/
}/*main end*/
